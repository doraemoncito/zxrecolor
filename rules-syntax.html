<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="img/favicon.ico">
        <title>Writing rules - ZX Recoloring Project</title>
        <link href="css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="css/font-awesome.min.css" rel="stylesheet">
        <link href="css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="js/jquery-1.10.2.min.js" defer></script>
        <script src="js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="index.html">ZX Recoloring Project</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="index.html">About</a>
                            </li>
                            <li >
                                <a href="hello-world.html">Hello, world!</a>
                            </li>
                            <li class="active">
                                <a href="rules-syntax.html">Writing rules</a>
                            </li>
                            <li >
                                <a href="handy-tools.html">Handy tools</a>
                            </li>
                            <li >
                                <a href="tips-and-tricks.html">Tips and tricks</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="hello-world.html">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="handy-tools.html">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#writing-rules">Writing rules</a></li>
            <li><a href="#settings-file">Settings file</a></li>
            <li><a href="#sprite-replacement-rules">Sprite replacement rules</a></li>
            <li><a href="#sound-rules">Sound rules</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="writing-rules">Writing rules</h1>
<p>This section is intended to be a succint yet complete description of rule types and rule syntax. It might be a bit difficult to read it due to lack of practical examples, so make sure to check out <a href="tips-and-tricks.html">Tips and tricks</a> section as well.</p>
<h2 id="settings-file">Settings file</h2>
<p>All required game transformations are performed by means of rules, listed in the <code>game\settings.txt</code> file. Each line of this file is a separate rule. Empty lines and lines starting with a semicolon symbol are ignored:</p>
<pre><code>; This is a comment

&lt;here-comes-my-first-rule&gt;
</code></pre>

<p>Rules are case-sensitive.</p>
<h2 id="sprite-replacement-rules">Sprite replacement rules</h2>
<p>Each sprite replacement rule can substitute an original ZX Spectrum sprite found on the screen with its upgraded version. Recolored screen is twice wider and twice higher (512x384) than the original screen (256x192), and imposes no color limits. Sprite replacement rules are described with the following syntax:</p>
<pre><code>&lt;layer-number&gt; &lt;rule-type&gt; &lt;original-sprite&gt; &lt;new-sprite&gt; [protected|N]
</code></pre>

<h3 id="layers">Layers</h3>
<p>If a game has non-blank background, it is necessary to ensure that foreground images (such as game characters) are drawn over the background rather than behind it. This can be achieved with layers: each subsequent layer is drawn only after the previous layer is complete. For example, all the sprites on the layer 1 will be drawn after all the sprites on the layer 0. The <code>layer-number</code> element should be an integer.</p>
<h3 id="replacement-rule-types">Replacement rule types</h3>
<p>Currently there are two types of sprite replacement rules: <code>block</code> and <code>pixel</code>. ZX Spectrum screen is logically divided into 8x8-pixel blocks, having independent color palettes. In practice it means that immovable background elements are typically aligned with the borders of such blocks.</p>
<p>Rules of <code>block</code> type search original sprites aligned with block corners only. In contrast, <code>pixel</code> rules check every location on the screen. There are two primary reasons to use <code>block</code> rules, where it is possible. First, they are much faster, since only block corner locations have to be checked. Second, they help fighting false positive matches. Sometimes, an accidental combination of pixels on the screen can form a "match" for a certain small sprite, causing the rule to trigger. If it is known that the original sprite is always block-aligned, we can minimize the chances of a false positive match.</p>
<h3 id="original-sprite-declaration">Original sprite declaration</h3>
<p>Original sprite declaration consists of the following elements:</p>
<pre><code>&lt;sprite-name&gt;.bmp[|x1,y1,color1[|x2,y2,color2[|...]]]
</code></pre>

<p>Color palette in ZX Spectrum is specified per 8x8 sprite block rather than per pixel. In practice it often leads to "color clashes" (incorrectly colored areas), apparent in many Spectrum games. For us it means that color matching is unreliable: we cannot be sure that the given sprite will always preserve its color palette.</p>
<p>Therefore, the basic matching procedure assumes that the original sprite does not contain any color information. It should be a 24bpp BMP image actually containing pixels of these colors only:</p>
<ul>
<li>white, <code>RGB(255, 255, 255)</code>: background "paper" color;</li>
<li>black, <code>RGB(0, 0, 0)</code>: foreground "ink" color;</li>
<li>pinkish, <code>RGB(242, 10, 242)</code>: transparent color, ignored in matching operations.</li>
</ul>
<p>Sometimes, however, color information is both reliable and necessary. Thus, there is an option to specify a list of colors of <em>individual</em> sprite pixels. For example, the declaration</p>
<pre><code>my_sprite.bmp|0,0,red|0,1,yellow
</code></pre>

<p>specifies that the match for <code>my_sprite.bmp</code> must have a black pixel in the top-left corner and a yellow pixel right under it. Color names are taken from the standard Spectrum vocabulary: <code>black</code>, <code>blue</code>, <code>red</code>, <code>magenta</code>, <code>green</code>, <code>cyan</code>, <code>yellow</code>, <code>white</code>. For brighter colors, add <code>+</code> to the color name: <code>black+</code>, <code>blue+</code>, <code>red+</code>, <code>magenta+</code>, <code>green+</code>, <code>cyan+</code>, <code>yellow+</code>, <code>white+</code>.</p>
<h3 id="recolored-sprite-declaration">Recolored sprite declaration</h3>
<p>Declaring recolored sprites is easier:</p>
<pre><code>&lt;new_sprite&gt;.bmp[|dx,dy]
</code></pre>

<p>Here the optional <code>|dx,dy</code> part allows to specify a relative displacement of the new sprite on the screen. For example, if you want to place the new sprite just a bit higher than the original matched fragment, use</p>
<pre><code>&lt;new_sprite&gt;.bmp|0,-1
</code></pre>

<p>Note that the numbers here correspond to the original ZX Spectrum screen dimensions. Thus, "-1" will actually become "two pixels higher" in the final double-size render.</p>
<h3 id="protected-clause">Protected clause</h3>
<p>The <code>[protected|N]</code> clause is one of handy tools designed to deal with incomplete matches. It works as follows:</p>
<ol>
<li>
<p>The system identifies missing protected sprites, matched on the previous frame.</p>
</li>
<li>
<p>For each protected sprite, the system tries to match at least <code>N</code> non-transparent sprite pixels in the original location.</p>
</li>
<li>
<p>If this is operation is successful, the sprite is considered found.</p>
</li>
</ol>
<p>In effect, this technique allows to match immovable background objects when other sprites partially obscure them. Note that both paper and ink pixels participate in matching procedure. Thus, for example, an empty (paper-only) 8x8 block has 32 matching pixels with any half-ink/half-paper block.</p>
<h2 id="sound-rules">Sound rules</h2>
<p>Sound rules let you add your own music and sound effects to the game. Their basic syntax is similar to the syntax of sprite replacement rules:</p>
<pre><code>&lt;channel-number&gt; &lt;rule-type&gt; &lt;original-sprite&gt; &lt;sound-sample-file&gt; &lt;event&gt; [flags] 
</code></pre>

<h3 id="channels">Channels</h3>
<p>Every playback event is associated with an integer channel number. A single channel cannot be shared between two active playback events. If you start playback on the given channel, the previously active playback session of this channel will be interrupted.</p>
<p>Zero channel is "exclusive": initiating a playback on the channel 0 will interrupt all other active playback events.</p>
<h3 id="sound-rule-types">Sound rule types</h3>
<p>Sound rules are triggered with the same pattern matching routines as sprite replacement rules. Hence, there are two types of sound rules: <code>sound-block</code> and <code>sound-pixel</code>. The <code>&lt;original-sprite&gt;</code> declaration also follows the syntax used in replacement rules.</p>
<h3 id="events">Events</h3>
<p>Sound playback is initiated when a specified events occurs. Currently, there are two types of sound events:</p>
<ul>
<li><code>appears</code>: occurs when the given sprite appears on the screen (it is found now, but was not found on the previous frame);</li>
<li><code>disappears</code>: occurs when the given sprite disappears from the screen (it is not found now, but was found on the previous frame).</li>
</ul>
<p>Events are used to initiate a playback; there are no dedicated means for stopping a playback. However, it is possible to play an empty/silent sound file on the given channel to achieve the same outcome.</p>
<h3 id="sound-samples">Sound samples</h3>
<p>A sound sample is a conventional audio file. A variety of formats are supported, including MP3, WAV, and OGG.</p>
<h3 id="flags">Flags</h3>
<p>You may want to mute regular Spectrum sound output while playing your custom samples. This is achieved with <code>mute_ay</code> and <code>mute_beeper</code> flags:</p>
<ul>
<li><code>mute_ay</code>: AY sound processor will be turned off while the rule is active;</li>
<li><code>mute_beeper</code>: regular ZX beeper will be turned off while the rule is active.</li>
</ul>
<p>This way, regular sound system of Spectrum will be turned on only if there are no active rules with these flags set.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = ".",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="js/base.js" defer></script>
        <script src="search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
